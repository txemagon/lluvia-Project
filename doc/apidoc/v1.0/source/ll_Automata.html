<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Engine-Automata'>/**
</span> * @class Engine.Automata
 *
 * Creates a state machine. A lluvia state machine has a continous and derivable state,
 * made of the previous, the current and the requested one. During state transition, several solicitor functions
 * get executed: down function of the current state, up solicitor of the requested state and finally we arrive to the
 * steady state.
 * @uses Kernel.Foundation.Enumerable.EnumerationOf
 * @uses Engine.State
 * @uses  Engine.StateGear
 *
 * ## States
 *
 * States refers to each of the states of a Finite Machine Automaton. See {@link Engine.State State}
 * for a very detailed explanation. States are injected with an attribute &#39;owner&#39; that refers to
 * the automata.
 *
 * ### Warning
 *
 *   Avoid using run for naming a state.
 *
 * ## Solicitors
 *
 * Solicitors are the drivers that run every single {@link Engine.State state}. Despite
 * you can manually add the drivers to every state, the Automata constructor comes with a
 * facility to specify all the drivers at once.
 *
 * Define an object as in the following example to be used as the solicitor constructor param:
 *
 *     {
 *            walking: function() {
 *                return &quot;I&#39;m walking&quot;
 *            },
 *            running: [
 *
 *                function() {
 *                    return &quot;I&#39;m running&quot;
 *                }, {
 *                    slow: function() {
 *                        return &quot;I&#39;m running slow&quot;
 *                    },
 *                    &quot;slow.steady&quot;: function() {
 *                        return &quot;But steadily&quot;
 *                    },
 *                    fast: function() {
 *                        return &quot;I&#39;m running fast&quot;
 *                    }
 *                }
 *            ]
 *        }
 *
 * See that when no substates are given you can directly define a function driver.
 * Notice too, that defining a regime driver is made by typing between quotes
 *
 * ## Inner Structure
 *
 *     var solicitors = {
 *             walking: function() {
 *                 return &quot;I&#39;m walking with my shoes.&quot;
 *             },
 *             &quot;walking.down&quot;: function() {
 *                 alert(&quot;Im taking my shoes off.&quot;)
 *
 *             },
 *             &quot;walking.up&quot;: function() {
 *                 alert(&quot;Im putting my shoes on.&quot;)
 *             },
 *             running: [
 *
 *                 function() {
 *                     return &quot;I&#39;m running&quot;
 *                 }, {
 *                     slow: function() {
 *                         return &quot;I&#39;m running slow&quot;
 *                     },
 *                     &quot;slow.up&quot;: function() {
 *                         alert(&quot;I got my slow sneakers&quot;)
 *                     },
 *                     &quot;slow.steady&quot;: function() {
 *                         return &quot;But steadily&quot;
 *                     },
 *                     fast: function() {
 *                         return &quot;I&#39;m running fast&quot;
 *                     }
 *                 }
 *             ],
 *             &quot;running.up&quot;: function() {
 *                 alert(&quot;Im putting my sneakers on.&quot;)
 *             },
 *             &quot;running.down&quot;: function() {
 *                 alert(&quot;Im taking my sneakers off.&quot;)
 *
 *             }
 *     }
 *
 *     var a = new Automata([&quot;*walking&quot;, &quot;running&quot;, [&quot;slow&quot;, &quot;fast&quot;]], solicitors)
 *     a.state.toSource()
 *
 *     //=&gt; ( { walking: {
 *     //=&gt;                0:   (function () {
 *     //=&gt;                         return State.prototype._run.apply(that, arguments)
 *     //=&gt;                     }),
 *     //=&gt;                run: (function () {
 *     //=&gt;                        return &quot;I&#39;m walking with my shoes.&quot;
 *     //=&gt;                     })
 *     //=&gt;              },
 *     //=&gt;     running: {
 *     //=&gt;                1:    (function () {
 *     //=&gt;                          return State.prototype._run.apply(that, arguments)
 *     //=&gt;                       }),
 *     //=&gt;                run:  (function () {
 *     //=&gt;                          return &quot;I&#39;m running&quot;
 *     //=&gt;                        }),
 *     //=&gt;                slow: {
 *     //=&gt;                        1:   {1:{}},
 *     //=&gt;                        run: (function () {
 *     //=&gt;                                  return &quot;I&#39;m running slow&quot;
 *     //=&gt;                              }),
 *     //=&gt;                        &#39;1.1&#39;:(function () {
 *     //=&gt;                                  return State.prototype._run.apply(that, arguments)
 *     //=&gt;                               })
 *     //=&gt;                      },
 *     //=&gt;                fast: {
 *     //=&gt;                        1: {2:{}},
 *     //=&gt;                        run: (function () {
 *     //=&gt;                                  return &quot;I&#39;m running fast&quot;
 *     //=&gt;                              }),
 *     //=&gt;                        &#39;1.2&#39;: (function () {
 *     //=&gt;                                     return State.prototype._run.apply(that, arguments)
 *     //=&gt;                                })
 *     //=&gt;                       }
 *     //=&gt;              },
 *     //=&gt;     none: {
 *     //=&gt;             &#39;-1&#39;: (function () {
 *     //=&gt;                         return State.prototype._run.apply(that, arguments)
 *     //=&gt;                   }),
 *     //=&gt;             run: (function () {})
 *     //=&gt;           }
 *     //=&gt; })
 *
 * As we can see, every state is made of a
 * {@link Kernel.Foundation.DataType.VersionNumber VersionNumber}, which is the
 * VersionNumber itself ( for fast will be: {1: {2:{}}} ) plus to additional
 * attributes: &#39;run&#39; and the result of VersionNumber#toString
 * (&#39;1.2&#39; in the example). When this attribute, containing a function, is
 * triggered a generic \_run function is called. Then user defined run function,
 * usually called the driver of the state is executed.
 *
 * Some additional functions can be defined as attributes of run: up, steady
 * and down, to be more precise. Those functions can be used to
 * facilitate a smooth transition between states.
 *
 * The automata is driven by an object (StateGear) that takes into account
 * when a transition is running on the Automata.
 *
 */

<span id='Engine-Automata-method-constructor'>/**
</span> * @method constructor
 *
 * ## Example
 *
 *     var state = new Enumeration(&quot;initial&quot;, &quot;running&quot;, &quot;sleeping&quot;)
 *     var a = new Automata( states,
 *                          {previous:  state.initial,
 *                           current:   state.initial,
 *                           requested: state.running })
 *
 *
 * or, for nested states:
 *
 *     var a = new Automata([&quot;killing&quot;, [&quot;running&quot;, [&quot;phase1&quot;, &quot;phase2&quot;], &quot;supended&quot; ]])
 *
 * If you want to request a given state upon start, please mark with an asterisk, as in this example.
 *
 *     var a = new Automata([&quot;killing&quot;, [&quot;running&quot;, [&quot;*phase1&quot;, &quot;phase2&quot;], &quot;supended&quot; ]])
 *
 * @param  {Object | Array}   states Possibles states of an automata (Enumeration).
 *                                   Array is an extension for Hierarchical State Machines.
 *                                   Avoid calling run to a state.
 * @param  {Array}    solicitor		 State Manager functions. An array with three functions (up, steady, down).
 * @return {Automata}				 New created state machine automata..
 * @constructor
 */
Automata.prototype.constructor = Automata;

function Automata(states, solicitor) {
    var that = this

    function initialize() {

        function find_initial_state(state_level, initial_state) {
            initial_state = initial_state || &quot;&quot;

            for (var i = 0; i &lt; state_level.length; i++) {
                if (state_level[i] instanceof Array) {
                    initial_state += &quot;.&quot; + state_level[i - 1]
                    return find_initial_state(state_level[i], initial_state)
                }
                if (Object.prototype.toString.call(state_level[i]) === &quot;[object String]&quot;) {
                    if (/^\*/.test(state_level[i])) {
                        state_level[i] = state_level[i].substring(1)
                        return initial_state + &quot;.&quot; + state_level[i]
                    }
                }
            }

        }

        var i_state = (find_initial_state(states) || &quot;&quot;).substring(1).split(&quot;.&quot;)

        if (states instanceof Array)
            states = new(ProxyConstructor(EnumerationOf, State, states))
        that.state = states ? states : new Enumeration()

        that.state.each(function(k, v) {
            v.owner = that
            Object.defineProperty(v, &#39;owner&#39;, {
                enumerable: false,
                writable: false
            })
        })

        // Always none equals to -1
        that.state.none = new State(State.NONE)

        var initial_state
        for (initial_state = that.state; i_state.length; initial_state = initial_state[i_state.shift()]);

        // todo: Make a proxyConstructor that handles the link via the this parameter.
        that.current = new StateGear(that, initial_state)
        that.current.zip(solicitor)

    }
    if (arguments.length)
        initialize()
}

<span id='Engine-Automata-property-state'>/**
</span> * @property {Enumeration} state Group of constants representing the
 *                               numbers for every possible state.
 *
 * ### Example
 *
 *     this.state = new Enumeration(&quot;killing&quot;, &quot;running&quot;, [&quot;phase1&quot;, &quot;phase2&quot;], &quot;supended&quot;)
 *     //=&gt; {
 *     //=&gt;    killing: 	{0:{}},
 *     //=&gt;    running: 	{1:{}, phase1:{1:{1:{}}}, phase2:{1:{2:{}}}},
 *     //=&gt;    supended: 	{2:{}})
 *     //=&gt; }
 *
 * Every value, despite it is actually an object, it behaves as a number.
 *
 *     this.state.running.phase2 == 2
 *     //=&gt; true
 *
 * And keeps track of its path.
 *
 *     this.state.running.phase2.toString()
 *     //=&gt; &quot;1.2&quot;
 *
 * Entrusted with the gifts of Enumeration we cand do:
 *
 *     this.state.keys()
 *     //=&gt; [&quot;killing&quot;, &quot;running&quot;, &quot;supended&quot;]
 *
 * and
 *
 *     this.state.running.branches()
 *     //=&gt; [&quot;phase1&quot;, &quot;phase2&quot;]
 *
 *
 * And because of the special VersionNumber method toString and the mathematical ring
 * composed by VersionNumber, InterleavedArray and Enumerate we can state:
 *
 *     // InterleavedArray mate.
 *     var i = new InterleavedArray(&quot;a&quot;, &quot;b&quot;, [&quot;b1&quot;, &quot;b2&quot;], &quot;c&quot;)
 *     i[this.state.running.phase1]
 *     //=&gt; &quot;b1&quot;
 *
 */


<span id='Engine-Automata-method-switch'>/**
</span> * @method switch
 * Selects a new state to be updated to in next run.
 *
 * @param  {String | State} state this.state.running.slow or &quot;running.slow&quot; for instance.
 */
Automata.prototype.switch = function(state) {
    if (Object.prototype.toString.call(state) == &quot;[object String]&quot;) {
        state = state.split(&quot;.&quot;)
        var s
        for (s = this.state; state.length; s = s[state.shift()]);
        state = s
    }
    this.current.requested = state
}


<span id='Engine-Automata-method-run'>/**
</span> * @method	  run
 * Behavior of the automata according to its internal state.
 * This function takes care of state transitions.
 *
 */
Automata.prototype.run = function() {
    return this.current.drive_state.apply(this.current, arguments)
}</pre>
</body>
</html>
